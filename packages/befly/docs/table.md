# 表字段定义规范

## 概述

Befly 框架使用 JSON 格式定义表字段的验证规则，这些规则用于数据验证、API 参数检查等场景。每个字段定义包含名称、类型、长度限制和特殊规则等信息。

## 字段定义格式

每个字段定义遵循以下格式：

```
"字段名": "显示名称,数据类型,最小值,最大值,特殊规则"
```

### 规则解析

字段定义由5个部分组成，使用逗号分隔：

1. **显示名称** - 字段的中文名称或描述
2. **数据类型** - 支持的数据类型（必须小写）
3. **最小值** - 最小长度/值限制，可为 `null`
4. **最大值** - 最大长度/值限制，可为 `null`
5. **特殊规则** - 正则表达式或计算表达式，可为 `null`

## 支持的数据类型

### 1. number（数字类型）

- 用于整数和浮点数
- 对应数据库字段类型：`BigInt`
- 最小值/最大值表示数值范围
- 特殊规则支持计算表达式（如：`x%2=0` 表示偶数）

**示例：**

```json
{
    "id": "ID,number,1,999999999,x%2=0",
    "page": "页码,number,1,9999,null",
    "enabled": "启用状态,number,0,1,null"
}
```

### 2. string（字符串类型）

- 用于短文本数据
- 对应数据库字段类型：`Varchar`
- 最小值/最大值表示字符串长度范围
- 特殊规则支持正则表达式验证

**示例：**

```json
{
    "email": "邮箱,string,5,100,^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}$",
    "phone": "手机号,string,11,11,^1[3-9]\\d{9}$",
    "title": "标题,string,1,200,null"
}
```

### 3. text（长文本类型）

- 用于大量文本数据
- 对应数据库字段类型：`MediumText`
- 最小值/最大值表示字符串长度范围
- 特殊规则支持正则表达式验证
- 适用于文章内容、详细描述等长文本场景

**示例：**

```json
{
    "content": "文章内容,text,0,1000000,null",
    "description": "详细描述,text,0,50000,null",
    "markdown": "Markdown内容,text,1,500000,null"
}
```

### 4. array（数组类型）

- 用于数组数据
- 对应数据库字段类型：`Varchar`（JSON格式存储）
- 最小值/最大值表示数组元素个数范围
- 特殊规则支持正则表达式验证数组元素

**示例：**

```json
{
    "tag": "标签,array,0,10,null"
}
```

## 特殊规则详解

### 数字类型的计算表达式

对于 `number` 类型，特殊规则可以使用计算表达式：

- 表达式格式：`计算公式=预期结果`
- 变量 `x` 代表输入的数值
- 支持的运算符：`+`、`-`、`*`、`/`、`%`、`(`、`)`
- 右侧必须是数字

**常用计算表达式：**

- `x%2=0` - 偶数验证
- `x%2=1` - 奇数验证
- `x*2=10` - 验证输入值的2倍等于10
- `(x+1)*2=6` - 复合计算验证

### 字符串、文本和数组的正则表达式

对于 `string`、`text` 和 `array` 类型，特殊规则使用正则表达式：

**常用正则表达式：**

- 邮箱：`^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}$`
- 手机号：`^1[3-9]\\d{9}$`
- 日期：`^\\d{4}-\\d{2}-\\d{2}$`
- 日期时间：`^\\d{4}-\\d{2}-\\d{2}T\\d{2}:\\d{2}:\\d{2}`
- URL：`^https?://`

## 保留字段

以下字段为系统保留字段，**不能**在表定义中使用：

- `id` - 主键ID
- `created_at` - 创建时间
- `updated_at` - 更新时间
- `deleted_at` - 删除时间
- `state` - 状态字段

## 验证规则

### 基本验证

1. **字段格式** - 必须包含5个部分，使用逗号分隔
2. **数据类型** - 必须是 `number`、`string`、`text`、`array` 之一（小写）
3. **数值验证** - 最小值/最大值必须是数字或 `null`
4. **保留字段** - 不能使用系统保留的字段名

### 特殊规则验证

1. **计算表达式安全性** - 只允许安全的数学运算符
2. **正则表达式有效性** - 必须是有效的正则表达式语法
3. **表达式结果** - 计算表达式的右侧必须是数字

## 示例文件

### common.json

通用字段定义，包含常用的数据类型和验证规则：

```json
{
    "email": "邮箱,string,5,100,^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}$",
    "phone": "手机号,string,11,11,^1[3-9]\\d{9}$",
    "page": "页码,number,1,9999,null",
    "limit": "每页数量,number,1,100,null",
    "title": "标题,string,1,200,null",
    "description": "描述,string,0,500,null",
    "enabled": "启用状态,number,0,1,null",
    "date": "日期,string,10,10,^\\d{4}-\\d{2}-\\d{2}$",
    "url": "网址,string,5,500,^https?://",
    "tag": "标签,array,0,10,null"
}
```

### tool.json

工具相关字段定义：

```json
{
    "filename": "文件名,string,1,255,null",
    "content": "内容,text,0,1000000,null",
    "type": "类型,string,0,50,null",
    "path": "路径,string,1,500,null"
}
```

## 数据库字段类型对应关系

Befly 框架的数据类型与数据库字段类型的对应关系如下：

| 数据类型 | 数据库字段类型 | 说明                             |
| -------- | -------------- | -------------------------------- |
| `number` | `BigInt`       | 大整数类型，支持大范围数值       |
| `string` | `Varchar`      | 可变长度字符串，适用于短文本     |
| `text`   | `MediumText`   | 中等长度文本，适用于大量文本内容 |
| `array`  | `Varchar`      | 以JSON格式存储的数组数据         |

## 最佳实践

1. **命名规范** - 使用有意义的字段名，避免使用保留字段
2. **类型选择** - 根据数据特性选择合适的数据类型
3. **长度限制** - 合理设置最小值和最大值，既要满足业务需求，又要防止异常数据
4. **正则表达式** - 编写简洁有效的正则表达式，注意转义字符
5. **计算表达式** - 保持表达式简单易懂，避免过于复杂的计算
6. **文档维护** - 及时更新字段定义，保持与业务逻辑同步

## 常见错误

1. **格式错误** - 字段定义不是5个部分
2. **类型错误** - 使用了不支持的数据类型或大小写错误
3. **数值错误** - 最小值/最大值不是数字或 `null`
4. **正则错误** - 正则表达式语法错误
5. **表达式错误** - 计算表达式包含不安全字符或结果不是数字
6. **保留字段** - 使用了系统保留的字段名

## 工具支持

使用 `checks/table.js` 脚本可以验证表定义文件的正确性：

```bash
# 运行表定义检查
node checks/table.js
```

检查工具会验证：

- 文件格式是否正确
- 字段定义是否符合规范
- 是否使用了保留字段
- 正则表达式和计算表达式是否有效
